#!/bin/sh

CLUSTER="dut=nslrack11-100G,nic=1+0 server=nslrack05-100G,nic=1 client=nslrack12-100G,nic=0"
GLOBAL="--use-last --show-full"

#Ensure CPU freq
sudo cpupower frequency-set -u 3700M -d 1000M

#motivation
#./npf-compare.py local:Forward local+nat:+NAT local+nat,haproxy:+HAProxy local+nat,snort,haproxy:+Snort local+nat,snort,squid,haproxy:+Squid --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables FSIZE=8 GEN_CONCURRENT=128 --tags motivation --graph-size 6 2.5 --output --graph-filename ~/workspace/middleclick-paper/figs/motivation/fnt.pdf $(echo "$GLOBAL")

#Motivation - profiling
#taskset --cpu-list 15 ./npf-compare.py local+nat,haproxy,pipeline,PERF_CPU=2:+HAProxy local+nat,haproxy,snort,pipeline,PERF_CPU=3:+Snort local+nat,haproxy,snort,squid,pipeline,PERF_CPU=4:+Squid --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables FSIZE=8 GEN_CONCURRENT=128 --tags motivation --graph-size 6 2.5 --graph-filename ~/workspace/middleclick-paper/figs/motivation/fnt-pipeline-profile.pdf --tags perf --config n_runs=1 --variables "PERF_CLASS_MAP=../libs/perf/kernel.map ../libs/perf/kernel_flow.map ../libs/perf/haproxy.map ../libs/perf/snort.map ../libs/perf/squid.map" $(echo "$GLOBAL")

#Figure not published, FWD, NAT, NAT+LB and IDS in Linux vs FastClick vs MiddleClick
#./npf-compare.py local:Linux local+nat:Linux local+nat,haproxy:Linux local+nat,haproxy,snort:Linux fastclick:FastClick fastclick+nat:FastClick fastclick+nat,lb:FastClick middleclick-dev:MiddleClick middleclick-dev+nat:MiddleClick middleclick-dev+nat,lb:MiddleClick middleclick-dev+nat,lb,tcp,ids:MiddleClick --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables FSIZE=8 GEN_CONCURRENT=128 --config n_runs=3 --show-full $(echo "$GLOBAL")


#Traffic class -firewall
#Older, not shown
#./npf-compare.py "fastclick+dpdk:FastClick" "fastclick+dpdk,nodrop:FastClick" "middleclick-static+dpdk,middleclick:MiddleClick" "middleclick-static+dpdk,middleclick,nodrop:MiddleClick" "middleclick-static+dpdk,middleclick,hw:MiddleClick-HW" "middleclick-static+dpdk,hw,middleclick,nodrop:MiddleClick-HW" --testie ~/workspace/middleclick-config/firewall-delay-single.testie --cluster $(echo "$CLUSTER") --tags nobind --config n_runs=3 --no-conntest --variables checksum=true --show-full --tags matchall --graph-size 5 2.1 --output --graph-filename ~/workspace/middleclick-paper/figs/firewall/firewall-delay-single.pdf --tags paper $(echo "$GLOBAL")
#Combined
#./npf-compare.py "fastclick+dpdk:FastClick" "fastclick+dpdk,nodrop:FastClick" "middleclick-static+dpdk,middleclick:MiddleClick" "middleclick-static+dpdk,middleclick,nodrop:MiddleClick" "middleclick-static+dpdk,middleclick,hw:MiddleClick-HW" "middleclick-static+dpdk,hw,middleclick,nodrop:MiddleClick-HW" "fastclick+dpdk,fwout,router:FastClick" "fastclick+dpdk,nodrop,fwout,router:FastClick" "middleclick-static+dpdk,middleclick,fwout,router:MiddleClick" "middleclick-static+dpdk,middleclick,nodrop,fwout,router:MiddleClick" "middleclick-static+dpdk,middleclick,hw,fwout,router:MiddleClick-HW" "middleclick-static+dpdk,hw,middleclick,nodrop,fwout,router:MiddleClick-HW" --testie ~/workspace/middleclick-config/firewall-delay-single.testie --cluster dut=nslrack11-100G,nic=1+0 client=nslrack12-100G,nic=0 --tags nobind --config n_runs=3 --no-conntest --variables checksum=true --show-full --tags matchall --graph-size 7 2.5 --output --graph-filename ~/workspace/middleclick-paper/figs/firewall/firewall-delay-single-combined.pdf --tags paper --config graph_show_values=1

#LB
./npf-compare.py fastclick+fwd:Forwarding local+haproxy:HAProxy local+nginxlb:NGINX fastclick+lb:FastClick middleclick-dev+fulllb:MiddleClick "middleclick-dev+fulllb,aggcache:MiddleClick Cache" "middleclick-dev+hw,fulllb:MiddleClick HW" "middleclick-dev+hw,aggcache,fulllb:MiddleClick HW+Cache" --testie ~/workspace/middleclick-config/fullchain.conf --cluster dut=nslrack11-100G,nic=1+0 server=nslrack05-100G,nic=1 client=nslrack12-100G,nic=0 --tags nobind --variables "GEN_CONCURRENT=256" "CPUFREQ=2400000" --config n_runs=3 --tags evaluation --graph-size 7 2.5 --config "var_lim+={THROUGHPUT:0-70}" "graph_color={3,1,1,2,5,5,5,5}" "legend_loc=outer center" "legend_ncol=3" "legend_bbox={0,1,1,.15}" --show-full --output --graph-filename ~/workspace/middleclick-paper/figs/loadbalancer/loadbalancer_2400.pdf
./npf-compare.py fastclick+fwd:Forwarding local+haproxy:HAProxy local+nginxlb:NGINX fastclick+lb:FastClick middleclick-dev+fulllb:MiddleClick "middleclick-dev+fulllb,aggcache:MiddleClick Cache" "middleclick-dev+hw,fulllb:MiddleClick HW" "middleclick-dev+hw,aggcache,fulllb:MiddleClick HW+Cache" --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables "GEN_CONCURRENT=256" "CPUFREQ=2400000" --config n_runs=3 --tags evaluation --graph-size 7 2 --config "var_lim+={THROUGHPUT:0-70}" "graph_color={3,1,1,2,5,5,5,5}" "legend_loc=outer center" "legend_ncol=3" "legend_bbox={0,1,1,.15}" --show-full --output --graph-filename ~/workspace/middleclick-paper/figs/loadbalancer/loadbalancer_rate_8K.pdf --variables GEN_RATE=8000 FSIZE=8 --tags wrkrate --config "var_log={LATENCY,time}" "var_lim+={CDFLAT:0-1,time:0.5-16}" "var_format+={result-CDFLAT:%.1f}" "var_names+={CDFLAT:CDF,time:Latency (µs)}" "var_ticks+={time:0.5+1+1.5+2+4+8+16}" "var_grid+={CDFLAT}" "var_repeat={CDFLAT}" time_precision=1 time_sync=0 result_add=0 graph_legend=False "graph_error={CDFLAT:none}" "graph_markers={ }"  "accept_zero={time,CDFLAT}" --variables GEN_TIME=10 $(echo "$GLOBAL")
./npf-compare.py fastclick+fwd:Forwarding local+haproxy:HAProxy local+nginxlb:NGINX fastclick+lb:FastClick middleclick-dev+fulllb:MiddleClick "middleclick-dev+fulllb,aggcache:MiddleClick Cache" "middleclick-dev+hw,fulllb:MiddleClick HW" "middleclick-dev+hw,aggcache,fulllb:MiddleClick HW+Cache" --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables "GEN_CONCURRENT=256" "CPUFREQ=2400000" --config n_runs=3 --tags evaluation --graph-size 7 2 --config "var_lim+={THROUGHPUT:0-70}" "graph_color={3,1,1,2,5,5,5,5}" "legend_loc=outer center" "legend_ncol=3" "legend_bbox={0,1,1,.15}" --show-full --output --graph-filename ~/workspace/middleclick-paper/figs/loadbalancer/loadbalancer_rate_1024K.pdf --variables GEN_RATE=1024000 FSIZE=8 --tags wrkrate --config "var_log={LATENCY,time}" "var_lim+={CDFLAT:0-1,time:4000-20000}" "var_ticks+={time:5000+7500+10000+15000+20000}" "var_format+={result-CDFLAT:%.1f}" "var_names+={CDFLAT:CDF,time:Latency (µs)}" "var_grid+={CDFLAT}" "var_repeat={CDFLAT}" time_precision=1 time_sync=0 result_add=0 graph_legend=False "graph_error={CDFLAT:none}" "graph_markers={ }" "accept_zero={time,CDFLAT}" --variables GEN_TIME=10 $(echo "$GLOBAL")

#SCchain
./npf-compare.py "local+nat:Linux NAT" "local+mos,nat:mOS NAT" "local+mos,stats:mOS Stream Stats" "fastclick+nat:FastClick NAT" "fastclick+nat,stats:FastClick NAT+Stats" "middleclick-dev+nat:MiddleClick NAT" "middleclick-dev+nat,stats:+Stats" "middleclick-dev+nat,stats,tcp:+TCP" "middleclick-dev+nat,stats,fc,tcp:+Stream stats" "middleclick-dev+nat,stats,fc,tcp,lb:+LB" "middleclick-dev+nat,stats,tcp,fc,lb,crc:+CRC" "middleclick-dev+nat,stats,tcp,fc,lb,crc,ids:+IDS" --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --variables "GEN_CONCURRENT=256" --graph-size 7 3 --config "var_lim+={THROUGHPUT:0-45}" "graph_color={8,4,4,1,1,3,3,5,5,5,5,7}" "legend_loc=outer center" "legend_ncol=3" "legend_bbox={0,1,1,.17}" --show-full --output --graph-filename ~/workspace/middleclick-paper/figs/schain/schain_all.pdf --variables FSIZE=8 "CPU=[1-4]" CPUFREQ=2400000 --tags nobind evaluation cpufreq aggcache hw schain cpufreq --config n_runs=3  --no-graph-time $(echo "$GLOBAL")

./npf-compare.py "local+nat:Linux NAT" "local+mos,nat:mOS NAT" "local+mos,stats:mOS Stream Stats" "fastclick+nat:FastClick NAT" "fastclick+nat,stats:FastClick NAT+Stats" "middleclick-dev+nat:MiddleClick NAT" "middleclick-dev+nat,stats:+Stats" "middleclick-dev+nat,stats,tcp:+TCP" "middleclick-dev+nat,stats,fc,tcp:+Stream stats" "middleclick-dev+nat,stats,fc,tcp,lb:+LB" "middleclick-dev+nat,stats,tcp,fc,lb,crc:+CRC" "middleclick-dev+nat,stats,tcp,fc,lb,crc,ids:+IDS" --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --variables "GEN_CONCURRENT=256" --graph-size 7 3 --config n_runs=3 "graph_legend=0" --output --graph-filename ~/workspace/middleclick-paper/figs/schain/schain_all_rate.pdf --variables FSIZE=8 "CPU=1" CPUFREQ=2400000 --tags evaluation cpufreq aggcache hw wrkrate schain nobind --no-graph-time $(echo "$GLOBAL")

#end of CPU FREQ !
sudo cpupower frequency-set -u 3700M -d 1000M

#Context
./npf-compare.py "middleclick-dev+wm:Forward" "middleclick-dev+wm,tcpstate:TCP state" "middleclick-dev+wm,tcp:+TCP" "middleclick-dev+wm,tcp,http:+HTTP" "middleclick-dev+wm,tcp,http,wm_alert:Alert" "middleclick-dev+wm,tcp,http,wm_replace:Mask" "middleclick-dev+wm,tcp,http,wm_remove:Remove" "middleclick-dev+wm,tcp,http,wm_full:Replace" --testie ~/workspace/middleclick-config/fullchain.conf --cluster $(echo "$CLUSTER") --tags nobind --variables "GEN_CONCURRENT=256" --config n_runs=3 --graph-size 7 2.5 --variables FSIZE=8 --tags hw aggcache --output --graph-filename ~/workspace/middleclick-paper/figs/context/context-compare.pdf $(echo "$GLOBAL")

